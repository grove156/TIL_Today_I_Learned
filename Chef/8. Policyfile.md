# 8. Policyfile
* Policyfile is a file containing information about node's
  * Policy_name
  * Default source for fetching cookbooks
  * Run list
  * Custom cookbook path
  * Optional cookbook
* Policyfile.rb is auto-generated by **chef generate cookbook** command

## 8.1 Policyfile.rb
```ruby
# Policyfile.rb - Describe how you want Chef Infra Client to build your system.
#
# For more information on the Policyfile feature, visit
# https://docs.chef.io/policyfile/

# A name that describes what the system you're building with Chef does.
name 'company_web'

# Where to find external cookbooks:
default_source :supermarket

# run_list: chef-client will run these recipes in the order specified.
run_list 'company_web::default'

# Specify a custom source for a single cookbook:
# cookbook 'example_cookbook', path: '../cookbooks/example_cookbook'
cookbook 'company_web', path: '../cookbooks/company_web'
cookbook 'myiis', path: '../cookbooks/myiis'
cookbook 'apache', path: '../cookbooks/apache'
```

Attribute:
* name : policyname. name attribute reflects the purpose of the machines where the policy will run - NAME MUST BE UNIQUE
* default_source : it specifies where the cookbooks are. (public or supermarket or chef infra server - supermarket is like Gtihub or Docker hub)
* run_list : this is the run list for any nodes using this policy
* cookbook 'COOKBOOK' path: '' : it declares non-default locaotion where cookbooks can be found - path start chef-repo folder

## 8.2 Policyfile.lock.json
* to apply policyfile to a node, Policyfile.lock.json has to be generated from policy.rb
* the actual information that is passed to the node is Policyfile.lock.json
* chef install [POLICY_NAME] command creates Policyfile.lock.json
```shell
$ chef install [POLICY_NAME]

$ chef install policyfile.rb
```

**example of policyfile.lock.json**

```json
{
  "revision_id": "f1a3d9e68c1ad879db892b7380e6f6f577014f8722943ed0990ba122796ad0c6",
  "name": "company_web",
  "run_list": [
    "recipe[company_web::default]"
  ],
  "included_policy_locks": [

  ],
  "cookbook_locks": {
    "apache": {
      "version": "0.1.0",
      "identifier": "1388ab3a29c60e80c2c8306203b8502f6952c0e4",
      "dotted_decimal_identifier": "5498293554103822.36242962079941560.88164560716004",
      "source": "../cookbooks/apache",
      "cache_key": null,
      "scm_info": null,
      "source_options": {
        "path": "../cookbooks/apache"
      }
    },
    "company_web": {
      "version": "0.1.0",
      "identifier": "d59bd5e6904576b4671f5b5a2432f09b8c608e0f",
      "dotted_decimal_identifier": "60125513037923702.50778880182199346.264550865735183",
      "source": "../cookbooks/company_web",
      "cache_key": null,
      "scm_info": {
        "scm": "git",
        "remote": null,
        "revision": null,
        "working_tree_clean": false,
        "published": false,
        "synchronized_remote_branches": [

        ]
      },
      "source_options": {
        "path": "../cookbooks/company_web"
      }
    },
    "myiis": {
      "version": "0.2.1",
      "identifier": "cd0db3edaf69e3616516c189c75c0d94f4a87b84",
      "dotted_decimal_identifier": "57717436663687651.27414221151651676.14933411003268",
      "source": "../cookbooks/myiis",
      "cache_key": null,
      "scm_info": null,
      "source_options": {
        "path": "../cookbooks/myiis"
      }
    }
  },
  "default_attributes": {

  },
  "override_attributes": {

  },
  "solution_dependencies": {
    "Policyfile": [
      [
        "apache",
        ">= 0.0.0"
      ],
      [
        "company_web",
        ">= 0.0.0"
      ],
      [
        "myiis",
        ">= 0.0.0"
      ]
    ],
    "dependencies": {
      "apache (0.1.0)": [

      ],
      "company_web (0.1.0)": [
        [
          "myiis",
          ">= 0.0.0"
        ],
        [
          "apache",
          ">= 0.0.0"
        ]
      ],
      "myiis (0.2.1)": [

      ]
    }
  }
}
```

## 8.3 Push policyfile to chef infra server

```shell
# syntax
$ chef push [POLICY_GROUP] [POLICY_NAME.lock.json]

$ chef push prod apache.lock.json
```
* Policy group : Policy group is an environment such as prod, dev, stg...
* Policy name : policy name is automatically set as name of policyfile.lock.json - in this case, apache is policy name

## 8.4 knife node policy set - command
```shell
$ knife node policy set [NODE_NAME] [POLICY_GROUP] [POLICY_NAME]

$ knife node policy set apache_web prod apache # refer to the apache.lock.json
```

## 8.5 Converge Linux node

```shell
# this is the part actaully setting the node as desired status
$ knife ssh [IP_ADDRESS of the node] -m -x [USERNAME] -P [PASSWORD] 'sudo chef-client'

$ knife ssh 192.168.0.2 -m -x myUser -p 1234 'sudo chef-client'
```

